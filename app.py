from flask import Flask, render_template, request, session

# Khởi tạo Flask app
app = Flask(__name__)
app.secret_key = 'your_secret_key_here'  # Thay bằng chuỗi bí mật an toàn

# Dictionary chứa dữ liệu quy đổi (đã mở rộng từ 17 đến 129)
csv_data = {
    129: {"A00": 29.27, "B00": 28.97, "C00": 29.75, "D01": 28.65, "A01": 29.12},
    128: {"A00": 29.21, "B00": 28.91, "C00": 29.69, "D01": 28.59, "A01": 29.06},
    127: {"A00": 29.15, "B00": 28.85, "C00": 29.63, "D01": 28.53, "A01": 29.00},
    126: {"A00": 29.09, "B00": 28.79, "C00": 29.57, "D01": 28.47, "A01": 28.94},
    125: {"A00": 29.03, "B00": 28.73, "C00": 29.51, "D01": 28.41, "A01": 28.88},
    124: {"A00": 28.97, "B00": 28.67, "C00": 29.45, "D01": 28.35, "A01": 28.82},
    123: {"A00": 28.91, "B00": 28.61, "C00": 29.39, "D01": 28.29, "A01": 28.76},
    122: {"A00": 28.85, "B00": 28.55, "C00": 29.33, "D01": 28.23, "A01": 28.70},
    121: {"A00": 28.79, "B00": 28.49, "C00": 29.27, "D01": 28.17, "A01": 28.64},
    120: {"A00": 28.73, "B00": 28.43, "C00": 29.21, "D01": 28.11, "A01": 28.58},
    119: {"A00": 28.67, "B00": 28.37, "C00": 29.15, "D01": 28.05, "A01": 28.52},
    118: {"A00": 28.61, "B00": 28.31, "C00": 29.09, "D01": 27.99, "A01": 28.46},
    117: {"A00": 28.55, "B00": 28.25, "C00": 29.03, "D01": 27.93, "A01": 28.40},
    116: {"A00": 28.49, "B00": 28.19, "C00": 28.97, "D01": 27.87, "A01": 28.34},
    115: {"A00": 28.43, "B00": 28.13, "C00": 28.91, "D01": 27.81, "A01": 28.28},
    114: {"A00": 28.37, "B00": 28.07, "C00": 28.85, "D01": 27.75, "A01": 28.22},
    113: {"A00": 28.31, "B00": 28.01, "C00": 28.79, "D01": 27.69, "A01": 28.16},
    112: {"A00": 28.25, "B00": 27.95, "C00": 28.73, "D01": 27.63, "A01": 28.10},
    111: {"A00": 28.19, "B00": 27.89, "C00": 28.67, "D01": 27.57, "A01": 28.04},
    110: {"A00": 28.13, "B00": 27.83, "C00": 28.61, "D01": 27.51, "A01": 27.98},
    109: {"A00": 28.07, "B00": 27.77, "C00": 28.55, "D01": 27.45, "A01": 27.92},
    108: {"A00": 28.01, "B00": 27.71, "C00": 28.49, "D01": 27.39, "A01": 27.86},
    107: {"A00": 27.95, "B00": 27.65, "C00": 28.43, "D01": 27.33, "A01": 27.80},
    106: {"A00": 27.89, "B00": 27.59, "C00": 28.37, "D01": 27.27, "A01": 27.74},
    105: {"A00": 27.83, "B00": 27.53, "C00": 28.31, "D01": 27.21, "A01": 27.68},
    104: {"A00": 27.77, "B00": 27.47, "C00": 28.25, "D01": 27.15, "A01": 27.62},
    103: {"A00": 27.71, "B00": 27.41, "C00": 28.19, "D01": 27.09, "A01": 27.56},
    102: {"A00": 27.65, "B00": 27.35, "C00": 28.13, "D01": 27.03, "A01": 27.50},
    101: {"A00": 27.59, "B00": 27.29, "C00": 28.07, "D01": 26.97, "A01": 27.44},
    100: {"A00": 27.53, "B00": 27.23, "C00": 28.01, "D01": 26.91, "A01": 27.38},
    99: {"A00": 27.47, "B00": 27.17, "C00": 27.95, "D01": 26.85, "A01": 27.32},
    98: {"A00": 27.41, "B00": 27.11, "C00": 27.89, "D01": 26.79, "A01": 27.26},
    97: {"A00": 27.35, "B00": 27.05, "C00": 27.83, "D01": 26.73, "A01": 27.20},
    96: {"A00": 27.29, "B00": 26.99, "C00": 27.77, "D01": 26.67, "A01": 27.14},
    95: {"A00": 27.23, "B00": 26.93, "C00": 27.71, "D01": 26.61, "A01": 27.08},
    94: {"A00": 27.17, "B00": 26.87, "C00": 27.65, "D01": 26.55, "A01": 27.02},
    93: {"A00": 27.11, "B00": 26.81, "C00": 27.59, "D01": 26.49, "A01": 26.96},
    92: {"A00": 27.05, "B00": 26.75, "C00": 27.53, "D01": 26.43, "A01": 26.90},
    91: {"A00": 26.99, "B00": 26.69, "C00": 27.47, "D01": 26.37, "A01": 26.84},
    90: {"A00": 26.93, "B00": 26.63, "C00": 27.41, "D01": 26.31, "A01": 26.78},
    89: {"A00": 26.87, "B00": 26.57, "C00": 27.35, "D01": 26.25, "A01": 26.72},
    88: {"A00": 26.81, "B00": 26.51, "C00": 27.29, "D01": 26.19, "A01": 26.66},
    87: {"A00": 26.75, "B00": 26.45, "C00": 27.23, "D01": 26.13, "A01": 26.60},
    86: {"A00": 26.69, "B00": 26.39, "C00": 27.17, "D01": 26.07, "A01": 26.54},
    85: {"A00": 26.63, "B00": 26.33, "C00": 27.11, "D01": 26.01, "A01": 26.48},
    84: {"A00": 26.57, "B00": 26.27, "C00": 27.05, "D01": 25.95, "A01": 26.42},
    83: {"A00": 26.51, "B00": 26.21, "C00": 26.99, "D01": 25.89, "A01": 26.36},
    82: {"A00": 26.45, "B00": 26.15, "C00": 26.93, "D01": 25.83, "A01": 26.30},
    81: {"A00": 26.39, "B00": 26.09, "C00": 26.87, "D01": 25.77, "A01": 26.24},
    80: {"A00": 26.33, "B00": 26.03, "C00": 26.81, "D01": 25.71, "A01": 26.18},
    79: {"A00": 26.27, "B00": 25.97, "C00": 26.75, "D01": 25.65, "A01": 26.12},
    78: {"A00": 26.21, "B00": 25.91, "C00": 26.69, "D01": 25.59, "A01": 26.06},
    77: {"A00": 26.15, "B00": 25.85, "C00": 26.63, "D01": 25.53, "A01": 26.00},
    76: {"A00": 26.09, "B00": 25.79, "C00": 26.57, "D01": 25.47, "A01": 25.94},
    75: {"A00": 26.03, "B00": 25.73, "C00": 26.51, "D01": 25.41, "A01": 25.88},
    74: {"A00": 25.97, "B00": 25.67, "C00": 26.45, "D01": 25.35, "A01": 25.82},
    73: {"A00": 25.91, "B00": 25.61, "C00": 26.39, "D01": 25.29, "A01": 25.76},
    72: {"A00": 25.85, "B00": 25.55, "C00": 26.33, "D01": 25.23, "A01": 25.70},
    71: {"A00": 25.79, "B00": 25.49, "C00": 26.27, "D01": 25.17, "A01": 25.64},
    70: {"A00": 25.73, "B00": 25.43, "C00": 26.21, "D01": 25.11, "A01": 25.58},
    69: {"A00": 25.67, "B00": 25.37, "C00": 26.15, "D01": 25.05, "A01": 25.52},
    68: {"A00": 25.61, "B00": 25.31, "C00": 26.09, "D01": 24.99, "A01": 25.46},
    67: {"A00": 25.55, "B00": 25.25, "C00": 26.03, "D01": 24.93, "A01": 25.40},
    66: {"A00": 25.49, "B00": 25.19, "C00": 25.97, "D01": 24.87, "A01": 25.34},
    65: {"A00": 25.43, "B00": 25.13, "C00": 25.91, "D01": 24.81, "A01": 25.28},
    64: {"A00": 25.37, "B00": 25.07, "C00": 25.85, "D01": 24.75, "A01": 25.22},
    63: {"A00": 25.31, "B00": 25.01, "C00": 25.79, "D01": 24.69, "A01": 25.16},
    62: {"A00": 25.25, "B00": 24.95, "C00": 25.73, "D01": 24.63, "A01": 25.10},
    61: {"A00": 25.19, "B00": 24.89, "C00": 25.67, "D01": 24.57, "A01": 25.04},
    60: {"A00": 25.13, "B00": 24.83, "C00": 25.61, "D01": 24.51, "A01": 24.98},
    59: {"A00": 25.07, "B00": 24.77, "C00": 25.55, "D01": 24.45, "A01": 24.92},
    58: {"A00": 25.01, "B00": 24.71, "C00": 25.49, "D01": 24.39, "A01": 24.86},
    57: {"A00": 24.95, "B00": 24.65, "C00": 25.43, "D01": 24.33, "A01": 24.80},
    56: {"A00": 24.89, "B00": 24.59, "C00": 25.37, "D01": 24.27, "A01": 24.74},
    55: {"A00": 24.83, "B00": 24.53, "C00": 25.31, "D01": 24.21, "A01": 24.68},
    54: {"A00": 24.77, "B00": 24.47, "C00": 25.25, "D01": 24.15, "A01": 24.62},
    53: {"A00": 24.71, "B00": 24.41, "C00": 25.19, "D01": 24.09, "A01": 24.56},
    52: {"A00": 24.65, "B00": 24.35, "C00": 25.13, "D01": 24.03, "A01": 24.50},
    51: {"A00": 24.59, "B00": 24.29, "C00": 25.07, "D01": 23.97, "A01": 24.44},
    50: {"A00": 24.53, "B00": 24.23, "C00": 25.01, "D01": 23.91, "A01": 24.38},
    49: {"A00": 24.47, "B00": 24.17, "C00": 24.95, "D01": 23.85, "A01": 24.32},
    48: {"A00": 24.41, "B00": 24.11, "C00": 24.89, "D01": 23.79, "A01": 24.26},
    47: {"A00": 24.35, "B00": 24.05, "C00": 24.83, "D01": 23.73, "A01": 24.20},
    46: {"A00": 24.29, "B00": 23.99, "C00": 24.77, "D01": 23.67, "A01": 24.14},
    45: {"A00": 24.23, "B00": 23.93, "C00": 24.71, "D01": 23.61, "A01": 24.08},
    44: {"A00": 24.17, "B00": 23.87, "C00": 24.65, "D01": 23.55, "A01": 24.02},
    43: {"A00": 24.11, "B00": 23.81, "C00": 24.59, "D01": 23.49, "A01": 23.96},
    42: {"A00": 24.05, "B00": 23.75, "C00": 24.53, "D01": 23.43, "A01": 23.90},
    41: {"A00": 23.99, "B00": 23.69, "C00": 24.47, "D01": 23.37, "A01": 23.84},
    40: {"A00": 23.93, "B00": 23.63, "C00": 24.41, "D01": 23.31, "A01": 23.78},
    39: {"A00": 23.87, "B00": 23.57, "C00": 24.35, "D01": 23.25, "A01": 23.72},
    38: {"A00": 23.81, "B00": 23.51, "C00": 24.29, "D01": 23.19, "A01": 23.66},
    37: {"A00": 23.75, "B00": 23.45, "C00": 24.23, "D01": 23.13, "A01": 23.60},
    36: {"A00": 23.69, "B00": 23.39, "C00": 24.17, "D01": 23.07, "A01": 23.54},
    35: {"A00": 23.63, "B00": 23.33, "C00": 24.11, "D01": 23.01, "A01": 23.48},
    34: {"A00": 23.57, "B00": 23.27, "C00": 24.05, "D01": 22.95, "A01": 23.42},
    33: {"A00": 23.51, "B00": 23.21, "C00": 23.99, "D01": 22.89, "A01": 23.36},
    32: {"A00": 23.45, "B00": 23.15, "C00": 23.93, "D01": 22.83, "A01": 23.30},
    31: {"A00": 23.39, "B00": 23.09, "C00": 23.87, "D01": 22.77, "A01": 23.24},
    30: {"A00": 23.33, "B00": 23.03, "C00": 23.81, "D01": 22.71, "A01": 23.18},
    29: {"A00": 23.27, "B00": 22.97, "C00": 23.75, "D01": 22.65, "A01": 23.12},
    28: {"A00": 23.21, "B00": 22.91, "C00": 23.69, "D01": 22.59, "A01": 23.06},
    27: {"A00": 23.15, "B00": 22.85, "C00": 23.63, "D01": 22.53, "A01": 23.00},
    26: {"A00": 23.09, "B00": 22.79, "C00": 23.57, "D01": 22.47, "A01": 22.94},
    25: {"A00": 23.03, "B00": 22.73, "C00": 23.51, "D01": 22.41, "A01": 22.88},
    24: {"A00": 22.97, "B00": 22.67, "C00": 23.45, "D01": 22.35, "A01": 22.82},
    23: {"A00": 22.91, "B00": 22.61, "C00": 23.39, "D01": 22.29, "A01": 22.76},
    22: {"A00": 22.85, "B00": 22.55, "C00": 23.33, "D01": 22.23, "A01": 22.70},
    21: {"A00": 22.79, "B00": 22.49, "C00": 23.27, "D01": 22.17, "A01": 22.64},
    20: {"A00": 22.73, "B00": 22.43, "C00": 23.21, "D01": 22.11, "A01": 22.58},
    19: {"A00": 22.67, "B00": 22.37, "C00": 23.15, "D01": 22.05, "A01": 22.52},
    18: {"A00": 22.61, "B00": 22.31, "C00": 23.09, "D01": 21.99, "A01": 22.46},
    17: {"A00": 22.55, "B00": 22.25, "C00": 23.03, "D01": 21.93, "A01": 22.40}
}

def convert_hsa_to_thpt(hsa_score):
    try:
        hsa_rounded = round(hsa_score)
        if hsa_rounded in csv_data:
            return csv_data[hsa_rounded]
        else:
            return {"error": f"Không có dữ liệu cho điểm HSA {hsa_rounded}"}
    except Exception as e:
        return {"error": str(e)}

@app.route("/", methods=["GET", "POST"])
def index():
    result = None
    last_hsa_score = session.get('last_hsa_score', None)

    if request.method == "POST":
        try:
            hsa_score = float(request.form["hsa_score"])
            if 17 <= hsa_score <= 129:
                result = convert_hsa_to_thpt(hsa_score)
                session['last_hsa_score'] = hsa_score
                last_hsa_score = hsa_score
            else:
                result = {"error": "Chỉ hỗ trợ điểm HSA từ 17 đến 129"}
        except:
            result = {"error": "Vui lòng nhập điểm hợp lệ"}

    return render_template("index.html", result=result, last_hsa_score=last_hsa_score)
