from flask import Flask, render_template, request, session
import os

app = Flask(__name__)
app.secret_key = 'your_secret_key_here'  # Thay bằng chuỗi bí mật an toàn

csv_data = {
    129: {"A00": 29.27, "B00": 28.97, "C00": 29.75, "D01": 28.65, "A01": 29.12},
    128: {"A00": 29.21, "B00": 28.97, "C00": 29.64, "D01": 29.04, "A01": 29.18},
    127: {"A00": 29.12, "B00": 28.77, "C00": 29.66, "D01": 28.52, "A01": 28.93},
    126: {"A00": 29.03, "B00": 28.60, "C00": 29.61, "D01": 28.45, "A01": 28.81},
    125: {"A00": 28.94, "B00": 28.41, "C00": 29.54, "D01": 28.36, "A01": 28.67},
    124: {"A00": 28.85, "B00": 28.24, "C00": 29.51, "D01": 28.30, "A01": 28.56},
    123: {"A00": 28.76, "B00": 28.07, "C00": 29.48, "D01": 28.17, "A01": 28.43},
    122: {"A00": 28.67, "B00": 27.90, "C00": 29.45, "D01": 28.08, "A01": 28.31},
    121: {"A00": 28.58, "B00": 27.73, "C00": 29.42, "D01": 27.96, "A01": 28.19},
    120: {"A00": 28.49, "B00": 27.56, "C00": 29.39, "D01": 27.85, "A01": 28.07},
    119: {"A00": 28.40, "B00": 27.39, "C00": 29.36, "D01": 27.75, "A01": 27.95},
    118: {"A00": 28.31, "B00": 27.48, "C00": 29.10, "D01": 27.68, "A01": 27.83},
    117: {"A00": 28.22, "B00": 27.57, "C00": 29.05, "D01": 27.62, "A01": 27.71},
    116: {"A00": 28.13, "B00": 27.48, "C00": 29.10, "D01": 27.68, "A01": 27.59},
    115: {"A00": 28.04, "B00": 27.37, "C00": 29.05, "D01": 27.62, "A01": 27.56},
    114: {"A00": 27.95, "B00": 27.25, "C00": 29.00, "D01": 27.55, "A01": 27.45},
    113: {"A00": 27.90, "B00": 27.12, "C00": 28.96, "D01": 27.41, "A01": 27.34},
    112: {"A00": 27.85, "B00": 27.12, "C00": 28.92, "D01": 27.47, "A01": 27.37},
    111: {"A00": 27.80, "B00": 27.05, "C00": 28.88, "D01": 27.43, "A01": 27.33},
    110: {"A00": 27.73, "B00": 26.98, "C00": 28.83, "D01": 27.28, "A01": 27.31},
    109: {"A00": 27.70, "B00": 26.92, "C00": 28.79, "D01": 27.34, "A01": 27.24},
    108: {"A00": 27.65, "B00": 26.80, "C00": 28.75, "D01": 27.28, "A01": 27.20},
    107: {"A00": 27.52, "B00": 26.70, "C00": 28.67, "D01": 27.22, "A01": 27.08},
    106: {"A00": 27.38, "B00": 26.55, "C00": 28.58, "D01": 27.13, "A01": 26.97},
    105: {"A00": 27.25, "B00": 26.40, "C00": 28.49, "D01": 27.06, "A01": 26.86},
    104: {"A00": 27.14, "B00": 26.28, "C00": 28.40, "D01": 26.97, "A01": 26.76},
    103: {"A00": 27.03, "B00": 26.17, "C00": 28.31, "D01": 26.88, "A01": 26.67},
    102: {"A00": 26.93, "B00": 26.05, "C00": 28.21, "D01": 26.80, "A01": 26.58},
    101: {"A00": 26.82, "B00": 25.93, "C00": 28.11, "D01": 26.72, "A01": 26.48},
    100: {"A00": 26.71, "B00": 25.82, "C00": 28.01, "D01": 26.63, "A01": 26.39},
    99: {"A00": 26.60, "B00": 25.70, "C00": 27.92, "D01": 26.53, "A01": 26.30},
    98: {"A00": 26.47, "B00": 25.55, "C00": 27.79, "D01": 26.46, "A01": 26.18},
    97: {"A00": 26.34, "B00": 25.40, "C00": 27.66, "D01": 26.32, "A01": 26.07},
    96: {"A00": 26.21, "B00": 25.25, "C00": 27.52, "D01": 26.28, "A01": 25.94},
    95: {"A00": 26.08, "B00": 25.10, "C00": 27.38, "D01": 26.19, "A01": 25.82},
    94: {"A00": 25.95, "B00": 24.95, "C00": 27.25, "D01": 26.10, "A01": 25.70},
    93: {"A00": 25.81, "B00": 24.80, "C00": 27.13, "D01": 25.99, "A01": 25.56},
    92: {"A00": 25.67, "B00": 24.65, "C00": 27.00, "D01": 25.88, "A01": 25.42},
    91: {"A00": 25.53, "B00": 24.50, "C00": 26.87, "D01": 25.28, "A01": 25.28},
    90: {"A00": 25.38, "B00": 24.35, "C00": 26.75, "D01": 25.67, "A01": 25.13},
    89: {"A00": 25.24, "B00": 24.20, "C00": 26.63, "D01": 25.56, "A01": 24.99},
    88: {"A00": 25.10, "B00": 24.05, "C00": 26.50, "D01": 25.44, "A01": 24.85},
    87: {"A00": 24.95, "B00": 23.91, "C00": 26.35, "D01": 25.34, "A01": 24.71},
    86: {"A00": 24.80, "B00": 23.77, "C00": 26.25, "D01": 25.23, "A01": 24.57},
    85: {"A00": 24.65, "B00": 23.63, "C00": 26.05, "D01": 25.12, "A01": 24.43},
    84: {"A00": 24.50, "B00": 23.49, "C00": 25.90, "D01": 25.01, "A01": 24.29},
    83: {"A00": 24.35, "B00": 23.35, "C00": 25.75, "D01": 24.90, "A01": 24.15},
    82: {"A00": 24.12, "B00": 23.12, "C00": 25.58, "D01": 24.70, "A01": 23.93},
    81: {"A00": 23.88, "B00": 22.88, "C00": 25.34, "D01": 24.50, "A01": 23.72},
    80: {"A00": 23.65, "B00": 22.65, "C00": 25.25, "D01": 24.30, "A01": 23.50},
    79: {"A00": 23.48, "B00": 22.46, "C00": 25.06, "D01": 24.15, "A01": 23.33},
    78: {"A00": 23.30, "B00": 22.28, "C00": 24.80, "D01": 24.00, "A01": 23.16},
    77: {"A00": 23.13, "B00": 22.09, "C00": 24.69, "D01": 23.85, "A01": 22.98},
    76: {"A00": 22.95, "B00": 21.90, "C00": 24.50, "D01": 23.70, "A01": 22.80},
    75: {"A00": 22.68, "B00": 21.65, "C00": 24.28, "D01": 23.48, "A01": 22.57},
    74: {"A00": 22.42, "B00": 21.40, "C00": 24.03, "D01": 23.27, "A01": 22.33},
    73: {"A00": 22.15, "B00": 21.15, "C00": 23.83, "D01": 23.05, "A01": 22.10},
    72: {"A00": 21.93, "B00": 20.94, "C00": 23.69, "D01": 22.86, "A01": 21.90},
    71: {"A00": 21.70, "B00": 20.73, "C00": 23.54, "D01": 22.66, "A01": 21.70},
    70: {"A00": 21.48, "B00": 20.51, "C00": 23.40, "D01": 22.47, "A01": 21.50},
    69: {"A00": 21.25, "B00": 20.30, "C00": 23.25, "D01": 22.27, "A01": 21.30},
    68: {"A00": 21.00, "B00": 20.03, "C00": 23.06, "D01": 22.03, "A01": 21.06},
    67: {"A00": 20.75, "B00": 19.75, "C00": 22.88, "D01": 21.84, "A01": 20.83},
    66: {"A00": 20.50, "B00": 19.48, "C00": 22.69, "D01": 21.62, "A01": 20.59},
    65: {"A00": 20.25, "B00": 19.20, "C00": 22.50, "D01": 21.40, "A01": 20.36},
    64: {"A00": 19.95, "B00": 18.93, "C00": 22.27, "D01": 21.15, "A01": 20.07},
    63: {"A00": 19.95, "B00": 18.66, "C00": 22.09, "D01": 20.90, "A01": 19.79},
    62: {"A00": 19.35, "B00": 18.39, "C00": 21.80, "D01": 20.65, "A01": 19.51},
    61: {"A00": 19.05, "B00": 18.12, "C00": 21.56, "D01": 20.40, "A01": 19.23},
    60: {"A00": 18.75, "B00": 17.85, "C00": 21.30, "D01": 20.15, "A01": 18.95},
    59: {"A00": 18.53, "B00": 17.66, "C00": 21.15, "D01": 19.94, "A01": 18.72},
    58: {"A00": 18.32, "B00": 17.46, "C00": 20.94, "D01": 19.74, "A01": 18.49},
    57: {"A00": 18.10, "B00": 17.27, "C00": 20.78, "D01": 19.53, "A01": 18.26},
    56: {"A00": 17.88, "B00": 17.07, "C00": 20.60, "D01": 19.33, "A01": 18.02},
    55: {"A00": 17.67, "B00": 16.88, "C00": 20.42, "D01": 19.12, "A01": 17.79},
    54: {"A00": 17.45, "B00": 16.68, "C00": 20.24, "D01": 18.92, "A01": 17.56},
    53: {"A00": 17.24, "B00": 16.49, "C00": 20.06, "D01": 18.71, "A01": 17.33},
    52: {"A00": 17.02, "B00": 16.30, "C00": 19.87, "D01": 18.50, "A01": 17.10},
    51: {"A00": 16.80, "B00": 16.10, "C00": 19.69, "D01": 18.30, "A01": 16.87},
    50: {"A00": 16.59, "B00": 15.91, "C00": 19.51, "D01": 18.09, "A01": 16.64},
    49: {"A00": 16.37, "B00": 15.71, "C00": 19.33, "D01": 17.89, "A01": 16.40},
    48: {"A00": 16.15, "B00": 15.52, "C00": 19.14, "D01": 17.68, "A01": 16.17},
    47: {"A00": 15.94, "B00": 15.33, "C00": 18.93, "D01": 17.47, "A01": 15.94},
    46: {"A00": 15.72, "B00": 15.13, "C00": 18.73, "D01": 17.28, "A01": 15.71},
    45: {"A00": 15.51, "B00": 14.94, "C00": 18.60, "D01": 17.06, "A01": 15.48},
    44: {"A00": 15.29, "B00": 14.75, "C00": 18.42, "D01": 16.86, "A01": 15.25},
    43: {"A00": 15.07, "B00": 14.55, "C00": 18.23, "D01": 16.65, "A01": 15.02},
    42: {"A00": 14.86, "B00": 14.35, "C00": 18.05, "D01": 16.45, "A01": 14.78},
    41: {"A00": 14.64, "B00": 14.15, "C00": 17.87, "D01": 16.24, "A01": 14.55},
    40: {"A00": 14.43, "B00": 13.97, "C00": 17.69, "D01": 16.03, "A01": 14.32},
    39: {"A00": 14.21, "B00": 13.77, "C00": 17.51, "D01": 15.83, "A01": 14.09},
    38: {"A00": 13.99, "B00": 13.58, "C00": 17.32, "D01": 15.62, "A01": 13.86},
    37: {"A00": 13.78, "B00": 13.38, "C00": 17.14, "D01": 15.42, "A01": 13.63},
    36: {"A00": 13.56, "B00": 13.19, "C00": 16.96, "D01": 15.21, "A01": 13.40},
    35: {"A00": 13.34, "B00": 13.00, "C00": 16.78, "D01": 15.00, "A01": 13.17},
    34: {"A00": 13.13, "B00": 12.80, "C00": 16.60, "D01": 14.80, "A01": 12.93},
    33: {"A00": 12.91, "B00": 12.61, "C00": 16.41, "D01": 14.59, "A01": 12.70},
    32: {"A00": 12.69, "B00": 12.41, "C00": 16.23, "D01": 14.39, "A01": 12.47},
    31: {"A00": 12.48, "B00": 12.22, "C00": 16.05, "D01": 14.18, "A01": 12.24},
    30: {"A00": 12.26, "B00": 12.02, "C00": 15.87, "D01": 13.98, "A01": 12.01},
    29: {"A00": 12.05, "B00": 11.83, "C00": 15.69, "D01": 13.77, "A01": 11.78},
    28: {"A00": 11.83, "B00": 11.64, "C00": 15.50, "D01": 13.56, "A01": 11.55},
    27: {"A00": 11.61, "B00": 11.44, "C00": 15.32, "D01": 13.36, "A01": 11.31},
    26: {"A00": 11.40, "B00": 11.25, "C00": 15.14, "D01": 13.15, "A01": 11.08},
    25: {"A00": 11.18, "B00": 11.05, "C00": 14.96, "D01": 12.95, "A01": 10.85},
    24: {"A00": 10.96, "B00": 10.86, "C00": 14.77, "D01": 12.74, "A01": 10.62},
    23: {"A00": 10.75, "B00": 10.67, "C00": 14.59, "D01": 12.53, "A01": 10.39},
    22: {"A00": 10.53, "B00": 10.47, "C00": 14.41, "D01": 12.33, "A01": 10.16},
    21: {"A00": 10.32, "B00": 10.28, "C00": 14.23, "D01": 12.12, "A01": 9.93},
    20: {"A00": 10.10, "B00": 10.08, "C00": 14.05, "D01": 11.92, "A01": 9.69},
    19: {"A00": 9.88, "B00": 9.89, "C00": 13.86, "D01": 11.71, "A01": 9.46},
    18: {"A00": 9.67, "B00": 9.69, "C00": 13.68, "D01": 11.51, "A01": 9.23},
    17: {"A00": 9.45, "B00": 9.50, "C00": 13.50, "D01": 11.30, "A01": 9.00}

}

def convert_hsa_to_thpt(hsa_score):
    try:
        hsa_rounded = round(hsa_score)
        if hsa_rounded in df["HSA"].values:
            row = df[df["HSA"] == hsa_rounded].iloc[0]
            return {
                "A00": row["A00"],
                "B00": row["B00"],
                "C00": row["C00"],
                "D01": row["D01"],
                "A01": row["A01"]
            }
        else:
            return {"error": f"Không có dữ liệu cho điểm HSA {hsa_rounded}"}
    except Exception as e:
        return {"error": str(e)}

@app.route("/", methods=["GET", "POST"])
def index():
    result = None
    last_hsa_score = session.get('last_hsa_score', None)

    if request.method == "POST":
        try:
            hsa_score = float(request.form["hsa_score"])
            if 17 <= hsa_score <= 129:
                result = convert_hsa_to_thpt(hsa_score)
                session['last_hsa_score'] = hsa_score
                last_hsa_score = hsa_score
            else:
                result = {"error": "Chỉ hỗ trợ điểm HSA từ 17 đến 129"}
        except:
            result = {"error": "Vui lòng nhập điểm hợp lệ"}

    return render_template("index.html", result=result, last_hsa_score=last_hsa_score)
